# =============================================================================
# Horizontal Pod Autoscaler (HPA)
# =============================================================================
# 목적: CPU/메모리 사용량에 따라 Pod 수를 자동으로 조정
#
# 동작 원리:
# 1. metrics-server가 Pod의 리소스 사용량 수집
# 2. 현재 사용률이 target을 초과하면 Pod 수 증가
# 3. 사용률이 낮아지면 Pod 수 감소 (cooldown 기간 후)
#
# 전제 조건:
# - metrics-server가 클러스터에 설치되어 있어야 함
# - Deployment에 resources.requests가 정의되어 있어야 함
# =============================================================================
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: myapp-hpa
  labels:
    app: myapp
spec:
  # 스케일링 대상 지정
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: myapp

  # ----- 레플리카 범위 -----
  minReplicas: 1      # 최소 1개 Pod 유지 (가용성)
  maxReplicas: 10     # 최대 10개까지 확장 (비용 제한)

  # ----- 스케일링 메트릭 -----
  metrics:
    # CPU 기반 스케일링
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          # CPU 사용률 70% 초과 시 스케일 아웃
          # 계산: (현재 사용량 / requests) * 100
          averageUtilization: 70

    # 메모리 기반 스케일링
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          # 메모리 사용률 80% 초과 시 스케일 아웃
          # JVM은 메모리를 미리 할당하므로 CPU보다 높게 설정
          averageUtilization: 80
