# =============================================================================
# Zookeeper StatefulSet & Services
# =============================================================================
# 목적: Kafka 클러스터의 코디네이터 (메타데이터 관리)
#
# Zookeeper 역할:
# - 브로커 등록 및 장애 감지
# - 토픽/파티션 메타데이터 저장
# - 컨슈머 그룹 오프셋 관리 (구버전)
# - 리더 선출 조정
#
# 참고: Kafka 3.x부터 KRaft 모드로 Zookeeper 없이 운영 가능
#       하지만 현재는 안정성을 위해 Zookeeper 모드 사용
# =============================================================================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: zookeeper
  labels:
    app: zookeeper
    component: kafka
spec:
  serviceName: zookeeper-headless
  replicas: 1               # 프로덕션에서는 3 또는 5 (홀수 권장)
  selector:
    matchLabels:
      app: zookeeper
  template:
    metadata:
      labels:
        app: zookeeper
        component: kafka
    spec:
      containers:
        - name: zookeeper
          # Confluent Platform 이미지 (Kafka와 버전 호환성 보장)
          image: confluentinc/cp-zookeeper:7.5.3
          ports:
            - containerPort: 2181
              name: client        # 클라이언트(Kafka) 연결 포트
            - containerPort: 2888
              name: follower      # 팔로워 → 리더 통신
            - containerPort: 3888
              name: election      # 리더 선출 통신

          env:
            # 클라이언트 연결 수신 포트
            - name: ZOOKEEPER_CLIENT_PORT
              value: "2181"
            # 기본 시간 단위 (ms), 하트비트 및 타임아웃 계산 기준
            - name: ZOOKEEPER_TICK_TIME
              value: "2000"

          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"

          volumeMounts:
            - name: zookeeper-data
              mountPath: /var/lib/zookeeper/data

  volumeClaimTemplates:
    - metadata:
        name: zookeeper-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi
---
# =============================================================================
# Zookeeper Service (ClusterIP)
# =============================================================================
# 목적: Kafka에서 zookeeper:2181로 접근하기 위한 서비스
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: zookeeper
  labels:
    app: zookeeper
spec:
  ports:
    - port: 2181
      name: client
  selector:
    app: zookeeper
---
# =============================================================================
# Zookeeper Headless Service
# =============================================================================
# 목적: Zookeeper 앙상블(클러스터) 구성 시 노드 간 통신
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: zookeeper-headless
  labels:
    app: zookeeper
spec:
  ports:
    - port: 2181
      name: client
    - port: 2888
      name: follower
    - port: 3888
      name: election
  clusterIP: None
  selector:
    app: zookeeper
