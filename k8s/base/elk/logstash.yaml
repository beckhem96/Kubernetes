# =============================================================================
# Logstash ConfigMap
# =============================================================================
# 목적: Logstash 파이프라인 및 서버 설정
#
# 파이프라인 구조:
# input  → 데이터 수집 (Kafka, Beats, 파일 등)
# filter → 데이터 가공 (파싱, 변환, 보강)
# output → 데이터 전송 (Elasticsearch, 파일 등)
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: logstash-config
  labels:
    app: logstash
data:
  # ----- 파이프라인 설정 -----
  logstash.conf: |
    input {
      # Kafka에서 로그 메시지 수신
      kafka {
        bootstrap_servers => "kafka:9092"
        topics => ["logs", "app-logs"]    # 구독할 토픽
        codec => json                      # JSON 형식 메시지 자동 파싱
        group_id => "logstash-consumer"   # 컨슈머 그룹 ID
        auto_offset_reset => "earliest"   # 처음부터 읽기 (새 그룹일 때)
      }
      # Filebeat/Metricbeat 등에서 직접 수신
      beats {
        port => 5044
      }
    }

    filter {
      # 로그 메시지 파싱
      if [message] {
        grok {
          # 타임스탬프 + 로그레벨 + 메시지 패턴 추출
          match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:log_level} %{GREEDYDATA:log_message}" }
        }
      }
      # 환경 정보 필드 추가
      mutate {
        add_field => { "environment" => "${ENVIRONMENT:default}" }
      }
    }

    output {
      # Elasticsearch로 전송
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        index => "logs-%{+YYYY.MM.dd}"    # 일별 인덱스 생성
      }
    }

  # ----- 서버 설정 -----
  logstash.yml: |
    http.host: "0.0.0.0"              # 모든 인터페이스에서 접속 허용
    xpack.monitoring.enabled: false   # X-Pack 모니터링 비활성화 (유료 기능)
---
# =============================================================================
# Logstash Deployment
# =============================================================================
# 목적: 로그 수집, 변환, Elasticsearch 전송
#
# Deployment 사용 이유 (StatefulSet 아님):
# - 상태를 저장할 필요 없음 (Kafka 오프셋은 Kafka가 관리)
# - 수평 확장이 자유로움
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: logstash
  labels:
    app: logstash
    component: elk
spec:
  replicas: 1
  selector:
    matchLabels:
      app: logstash
  template:
    metadata:
      labels:
        app: logstash
        component: elk
    spec:
      containers:
        - name: logstash
          image: docker.elastic.co/logstash/logstash:8.15.0
          ports:
            - containerPort: 5044
              name: beats           # Beats 입력 포트
            - containerPort: 9600
              name: monitoring      # 모니터링 API 포트

          env:
            # 파이프라인에서 사용할 환경 변수
            - name: ENVIRONMENT
              value: "default"

          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"         # JVM 기반이므로 메모리 여유 필요
              cpu: "500m"

          # ConfigMap을 파일로 마운트
          volumeMounts:
            # 파이프라인 설정
            - name: config
              mountPath: /usr/share/logstash/pipeline/logstash.conf
              subPath: logstash.conf
            # 서버 설정
            - name: config
              mountPath: /usr/share/logstash/config/logstash.yml
              subPath: logstash.yml

      volumes:
        - name: config
          configMap:
            name: logstash-config
---
# =============================================================================
# Logstash Service
# =============================================================================
# 목적: Beats 에이전트에서 logstash:5044로 로그 전송
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: logstash
  labels:
    app: logstash
spec:
  ports:
    - port: 5044
      name: beats
    - port: 9600
      name: monitoring
  selector:
    app: logstash
